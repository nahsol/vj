<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tab Audio Visualizer — Firefly Strobes (No Mosh)</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    #ui{
      position:fixed; top:16px; left:16px; z-index:10;
      display:flex; gap:10px; align-items:center;
      background:rgba(10,12,18,.55); border:1px solid rgba(255,255,255,.08);
      padding:10px 12px; border-radius:14px; backdrop-filter: blur(8px);
      color:#e8eaf0; font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto;
    }
    button{ border:0; border-radius:12px; padding:10px 12px; background:#1b2140; color:#fff; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    input[type="range"]{ width:160px; }
    canvas{ display:block; width:100vw; height:100vh; }
    .hint{ opacity:.85; font-size:12px; }
  </style>
</head>
<body>
  <div id="ui">
    <button id="startBtn">탭 오디오 연결</button>
    <button id="stopBtn" disabled>정지</button>
    <label>감도 <input id="gain" type="range" min="0" max="2.5" step="0.01" value="1.10"></label>
    <div class="hint">공유창에서 “탭 오디오 공유” 체크</div>
  </div>

  <canvas id="c"></canvas>

  <script>
    const canvas  = document.getElementById('c');
    const ctx     = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const gainEl   = document.getElementById('gain');

    let ac, analyser, srcNode, gainNode, data;
    let stream, rafId;
    let DPR = 1;

    function resize(){
      DPR = Math.max(1, Math.min(1.5, window.devicePixelRatio || 1)); // 성능
      canvas.width  = Math.floor(innerWidth * DPR);
      canvas.height = Math.floor(innerHeight * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }
    addEventListener('resize', resize);
    resize();

    function energyFromBins(arr, start, end){
      let sum = 0;
      for (let i=start; i<end; i++) sum += arr[i];
      return sum / (end - start) / 255;
    }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function smoothstep(a,b,x){ x=clamp01((x-a)/(b-a)); return x*x*(3-2*x); }

    // ===== Firefly Strobes (true blink) =====
    const flies = [];
    const MAX_FLIES = 140;     // 성능 안정
    let t = 0;

    // 예쁜 색: 민트/라일락/바이올렛/웜펄
    const fireColors = [
      [185, 82, 62], // mint
      [210, 70, 62], // cool lilac-blue
      [265, 72, 64], // violet
      [330, 70, 62], // magenta
      [35,  85, 62], // warm pearl
    ];
    function pickColor(){
      const c = fireColors[(Math.random()*fireColors.length)|0];
      return [
        c[0] + (Math.random()*10 - 5),
        c[1] + (Math.random()*10 - 5),
        c[2] + (Math.random()*10 - 5),
      ];
    }

    function newFly(){
      const [h,s,l] = pickColor();
      return {
        x: Math.random()*innerWidth,
        y: Math.random()*innerHeight,
        vx: (Math.random()-0.5) * 0.25,
        vy: (Math.random()-0.5) * 0.25,
        baseR: 0.8 + Math.random()*1.6,
        h,s,l,
        life:  120 + Math.random()*220,
        age: 0,

        // ✅ "번쩍"을 만드는 핵심: 꺼짐 상태가 기본, 가끔 펄스가 터짐
        pulse: 0,          // 현재 번쩍 강도(0이면 완전 꺼짐)
        cooldown: Math.random()*60, // 다음 번쩍까지 남은 프레임
      };
    }

    function ensureFlies(n){
      while (flies.length < n) flies.push(newFly());
    }

    function warpWrap(f){
      if (f.x < -40) f.x = innerWidth + 40;
      if (f.x > innerWidth + 40) f.x = -40;
      if (f.y < -40) f.y = innerHeight + 40;
      if (f.y > innerHeight + 40) f.y = -40;
    }

    function draw(){
      rafId = requestAnimationFrame(draw);
      analyser.getByteFrequencyData(data);

      const mid  = energyFromBins(data, 18, 80);
      const high = energyFromBins(data, 80, 180);
      const g = parseFloat(gainEl.value);

      // 킥 무시: 하이/미드 중심
      const energy = clamp01((mid*0.75 + high*1.00) * g);
      const e = smoothstep(0.08, 0.75, energy);

      t += 0.016;

      // ✅ 배경은 매 프레임 "진짜 검정"으로 유지 (잔상/모쉬 없음)
      ctx.globalCompositeOperation = "source-over";
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,innerWidth,innerHeight);

      // 개체 수: 음악 올라가면 조금 늘리기
      const target = Math.floor(70 + e*60); // 70~130
      ensureFlies(Math.min(MAX_FLIES, target));

      // ✅ 블러: 번쩍이 강할 때만 두껍게
      // (평소엔 거의 안 보이니까 “번쩍”이 더 극적으로 보임)
      const baseBlur = 1.0 + e*4.0;

      // 합성: screen은 “불빛만”에 적용 (배경은 black)
      ctx.globalCompositeOperation = "screen";

      for (let i=flies.length-1; i>=0; i--){
        const f = flies[i];
        f.age++;
        if (f.age > f.life){
          flies[i] = newFly();
          continue;
        }

        // 움직임: 기본은 느림, 음악 올라가면 "갑자기 튀기" 이벤트 증가
        const twitch = 0.002 + e*0.020;
        if (Math.random() < twitch){
          f.vx += (Math.random()-0.5) * (1.2 + e*2.0);
          f.vy += (Math.random()-0.5) * (1.2 + e*2.0);
          // 튈 때 같이 한 번 번쩍
          f.pulse = Math.max(f.pulse, 0.7 + e*0.6);
        }

        // 드리프트
        f.vx += Math.sin(t*0.7 + f.x*0.002)*0.01;
        f.vy += Math.cos(t*0.6 + f.y*0.002)*0.01;
        f.vx *= 0.94; f.vy *= 0.94;
        f.x += f.vx; f.y += f.vy;
        warpWrap(f);

        // ✅ 진짜 "번쩍": 펄스 기반 (평소엔 거의 0)
        // - e가 높을수록 번쩍이 더 자주, 더 강하게
        f.cooldown -= (0.8 + e*1.8);
        if (f.cooldown <= 0){
          // 번쩍 강도: 하이가 많을수록 더 강함
          const strength = clamp01(0.35 + e*0.85);
          f.pulse = Math.max(f.pulse, strength);
          // 다음 번쩍까지: 음악이 높을수록 간격이 짧아짐
          const minCd = 8  - e*4;     // 4~8
          const maxCd = 80 - e*45;    // 35~80
          f.cooldown = minCd + Math.random()*Math.max(6, maxCd);
        }

        // 펄스는 빠르게 꺼졌다 켜지는 맛: 공격 빠르고 감쇠 빠름
        // (strobe 느낌)
        f.pulse *= (0.72 - e*0.10);  // e 높을수록 더 빨리 사라져 "번쩍" 느낌 강화
        if (f.pulse < 0.01) f.pulse = 0;

        if (f.pulse <= 0) continue; // ✅ 꺼져있으면 아예 안 그려서 “번쩍”만 남김

        const intensity = f.pulse;

        const r = f.baseR * (1.0 + intensity*10.0); // 번쩍 때 커짐
        const L = Math.min(78, f.l + intensity*14);

        // 블러는 번쩍 강도에 따라 가변
        ctx.filter = `blur(${baseBlur + intensity*10}px)`;

        // 3중 글로우: 코어/글로우/헤이즈
        ctx.fillStyle = `hsla(${f.h},${f.s}%,${L}%,${0.10 + intensity*0.25})`;
        ctx.beginPath();
        ctx.arc(f.x, f.y, r, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = `hsla(${f.h},${f.s}%,${L}%,${0.06 + intensity*0.16})`;
        ctx.beginPath();
        ctx.arc(f.x, f.y, r*2.2, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = `hsla(${f.h},${f.s}%,${L}%,${0.04 + intensity*0.12})`;
        ctx.beginPath();
        ctx.arc(f.x, f.y, r*4.0, 0, Math.PI*2);
        ctx.fill();
      }

      ctx.filter = "none";
      ctx.globalCompositeOperation = "source-over";
    }

    // ✅ 오디오 캡처: 안정 버전 유지
    async function start(){
      try{
        stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });

        ac = new (window.AudioContext || window.webkitAudioContext)();
        analyser = ac.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.86;

        gainNode = ac.createGain();
        gainNode.gain.value = 1.0;

        srcNode = ac.createMediaStreamSource(stream);
        srcNode.connect(gainNode);
        gainNode.connect(analyser);

        data = new Uint8Array(analyser.frequencyBinCount);

        startBtn.disabled = true;
        stopBtn.disabled = false;

        const [vtrack] = stream.getVideoTracks();
        if (vtrack) vtrack.onended = stop;

        if (ac.state === 'suspended') await ac.resume();

        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,innerWidth,innerHeight);

        flies.length = 0;
        draw();
      } catch (e){
        console.error(e);
        alert('캡처 시작 실패. 공유창에서 "탭" 선택 + "탭 오디오 공유" 체크 확인!');
      }
    }

    function stop(){
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;

      if (stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
      if (ac){ ac.close(); ac = null; }

      flies.length = 0;

      startBtn.disabled = false;
      stopBtn.disabled = true;

      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,innerWidth,innerHeight);
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
  </script>
</body>
</html>
